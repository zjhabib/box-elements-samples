{"version":3,"sources":["../../../src/features/unified-share-modal/ContactsField.js"],"names":["React","FormattedMessage","injectIntl","debounce","noop","classNames","PillSelectorDropdown","ContactDatalistItem","computeSuggestedCollabs","parseEmails","commonMessages","messages","isSubstring","value","searchString","toLowerCase","indexOf","ContactsField","props","contacts","suggestedCollaborators","pillSelectorInputValue","state","suggestedOptions","otherOptions","setState","numSuggestedShowing","length","selectedContacts","fullContacts","filter","name","email","id","find","addSuggestedContacts","map","isExternalUser","type","text","query","getContacts","then","filteredContacts","filterContacts","catch","error","isCanceled","getContactsPromise","onInput","trimmedValue","trim","debouncedGetContacts","disabled","fieldRef","getContactAvatarUrl","intl","label","onContactAdd","onContactRemove","onPillCreate","showContactAvatars","validateForError","validator","groupLabel","shouldShowSuggested","pillSelectorOverlayClasses","scrollable","undefined","autoFocus","onChange","handlePillSelectorInput","formatMessage","suggestedCollabsTitle","pillSelectorPlaceholder","Component","ContactsFieldBase"],"mappings":"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","sourcesContent":["// @flow\n\nimport * as React from 'react';\nimport { FormattedMessage, injectIntl } from 'react-intl';\nimport debounce from 'lodash/debounce';\nimport noop from 'lodash/noop';\nimport classNames from 'classnames';\n\nimport PillSelectorDropdown from '../../components/pill-selector-dropdown';\nimport ContactDatalistItem from '../../components/contact-datalist-item';\nimport computeSuggestedCollabs from './utils/computeSuggestedCollabs';\nimport parseEmails from '../../utils/parseEmails';\nimport commonMessages from '../../common/messages';\n\nimport messages from './messages';\nimport type { SuggestedCollabLookup, contactType as Contact } from './flowTypes';\nimport type { SelectOptionProp } from '../../components/select-field/props';\n\ntype Props = {\n    disabled: boolean,\n    error: string,\n    fieldRef?: Object,\n    getContactAvatarUrl?: (contact: Contact) => string,\n    getContacts: (query: string) => Promise<Array<Contact>>,\n    intl: any,\n    label: React.Node,\n    onContactAdd: Function,\n    onContactRemove: Function,\n    onInput?: Function,\n    onPillCreate?: (pills: Array<SelectOptionProp | Contact>) => void,\n    selectedContacts: Array<Contact>,\n    showContactAvatars?: boolean,\n    suggestedCollaborators?: SuggestedCollabLookup,\n    validateForError: Function,\n    validator: Function,\n};\n\ntype State = {\n    contacts: Array<Contact>,\n    numSuggestedShowing: number,\n    pillSelectorInputValue: string,\n};\n\nconst isSubstring = (value, searchString) => {\n    return value && value.toLowerCase().indexOf(searchString.toLowerCase()) !== -1;\n};\n\nclass ContactsField extends React.Component<Props, State> {\n    static defaultProps = {\n        showContactAvatars: false,\n    };\n\n    constructor(props: Props) {\n        super(props);\n\n        this.state = {\n            contacts: [],\n            numSuggestedShowing: 0,\n            pillSelectorInputValue: '',\n        };\n    }\n\n    addSuggestedContacts = (contacts: Array<Contact>) => {\n        const { suggestedCollaborators = {} } = this.props;\n        const { pillSelectorInputValue } = this.state;\n\n        const [suggestedOptions, otherOptions] = computeSuggestedCollabs(\n            contacts,\n            suggestedCollaborators,\n            pillSelectorInputValue,\n        );\n        this.setState({ numSuggestedShowing: suggestedOptions.length });\n        return [...suggestedOptions, ...otherOptions];\n    };\n\n    filterContacts = (contacts: Array<Contact>): Array<Contact> => {\n        const { pillSelectorInputValue } = this.state;\n        const { selectedContacts, suggestedCollaborators } = this.props;\n        if (pillSelectorInputValue && contacts) {\n            let fullContacts = contacts\n                .filter(\n                    // filter contacts whose name or email don't match input value\n                    ({ name, email }) =>\n                        isSubstring(name, pillSelectorInputValue) || isSubstring(email, pillSelectorInputValue),\n                )\n                .filter(\n                    // filter contacts who have already been selected\n                    ({ email, id }) => !selectedContacts.find(({ value }) => value === email || value === id),\n                );\n\n            if (suggestedCollaborators) {\n                fullContacts = this.addSuggestedContacts(fullContacts);\n            }\n\n            return fullContacts.map<Contact>(({ email, id, isExternalUser, name, type }) => ({\n                // map to standardized DatalistItem format\n                // TODO: refactor this so inline conversions aren't required at every usage\n                email,\n                id,\n                isExternalUser,\n                text: name,\n                type,\n                value: email || id, // if email doesn't exist, contact is a group, use id\n            }));\n        }\n\n        // return empty selector options if input value is empty\n        return [];\n    };\n\n    getContactsPromise = (query: string) => {\n        return this.props\n            .getContacts(query)\n            .then(contacts => {\n                const filteredContacts = this.filterContacts(contacts);\n                this.setState({ contacts: filteredContacts });\n            })\n            .catch(error => {\n                if (error.isCanceled) {\n                    // silently fail - this happens often when requests get cancelled\n                    // due to overlapping requests\n                    return;\n                }\n                throw error;\n            });\n    };\n\n    debouncedGetContacts = debounce(this.getContactsPromise, 200);\n\n    handlePillSelectorInput = (value: string) => {\n        const { onInput } = this.props;\n        const trimmedValue = value.trim();\n\n        this.setState({\n            pillSelectorInputValue: trimmedValue,\n        });\n\n        if (onInput) {\n            onInput(value);\n        }\n\n        if (!trimmedValue) {\n            this.setState({ contacts: [] });\n            return;\n        }\n\n        this.debouncedGetContacts(trimmedValue);\n    };\n\n    render() {\n        const {\n            disabled,\n            error,\n            fieldRef,\n            getContactAvatarUrl,\n            intl,\n            label,\n            onContactAdd,\n            onContactRemove,\n            onPillCreate,\n            selectedContacts,\n            showContactAvatars,\n            validateForError,\n            validator,\n        } = this.props;\n        const { contacts, numSuggestedShowing } = this.state;\n        const groupLabel = <FormattedMessage {...messages.groupLabel} />;\n        const shouldShowSuggested = numSuggestedShowing > 0;\n        const pillSelectorOverlayClasses = classNames({\n            scrollable: contacts.length > 5,\n        });\n\n        return (\n            <PillSelectorDropdown\n                allowCustomPills\n                className={pillSelectorOverlayClasses}\n                dividerIndex={shouldShowSuggested ? numSuggestedShowing : undefined}\n                disabled={disabled}\n                error={error}\n                getPillImageUrl={getContactAvatarUrl}\n                inputProps={{\n                    autoFocus: true,\n                    onChange: noop,\n                }}\n                label={label}\n                onInput={this.handlePillSelectorInput}\n                onRemove={onContactRemove}\n                onSelect={onContactAdd}\n                onPillCreate={onPillCreate}\n                overlayTitle={shouldShowSuggested ? intl.formatMessage(messages.suggestedCollabsTitle) : undefined}\n                parseItems={parseEmails}\n                placeholder={intl.formatMessage(commonMessages.pillSelectorPlaceholder)}\n                ref={fieldRef}\n                selectedOptions={selectedContacts}\n                showRoundedPills\n                selectorOptions={contacts}\n                validateForError={validateForError}\n                validator={validator}\n            >\n                {contacts.map(({ email, isExternalUser, text = null, id }) => (\n                    <ContactDatalistItem\n                        getContactAvatarUrl={getContactAvatarUrl}\n                        key={id}\n                        id={id}\n                        isExternal={isExternalUser}\n                        name={text}\n                        subtitle={email || groupLabel}\n                        title={text}\n                        showAvatar={showContactAvatars}\n                    />\n                ))}\n            </PillSelectorDropdown>\n        );\n    }\n}\n\nexport { ContactsField as ContactsFieldBase };\nexport default injectIntl(ContactsField);\n"],"file":"ContactsField.js"}