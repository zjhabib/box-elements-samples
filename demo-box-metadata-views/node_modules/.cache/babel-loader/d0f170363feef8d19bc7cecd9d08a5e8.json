{"ast":null,"code":"function _typeof(obj) {\n  \"@babel/helpers - typeof\";\n\n  if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") {\n    _typeof = function _typeof(obj) {\n      return typeof obj;\n    };\n  } else {\n    _typeof = function _typeof(obj) {\n      return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj;\n    };\n  }\n  return _typeof(obj);\n}\nfunction _extends() {\n  _extends = Object.assign || function (target) {\n    for (var i = 1; i < arguments.length; i++) {\n      var source = arguments[i];\n      for (var key in source) {\n        if (Object.prototype.hasOwnProperty.call(source, key)) {\n          target[key] = source[key];\n        }\n      }\n    }\n    return target;\n  };\n  return _extends.apply(this, arguments);\n}\nfunction _toConsumableArray(arr) {\n  return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread();\n}\nfunction _nonIterableSpread() {\n  throw new TypeError(\"Invalid attempt to spread non-iterable instance\");\n}\nfunction _iterableToArray(iter) {\n  if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === \"[object Arguments]\") return Array.from(iter);\n}\nfunction _arrayWithoutHoles(arr) {\n  if (Array.isArray(arr)) {\n    for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) {\n      arr2[i] = arr[i];\n    }\n    return arr2;\n  }\n}\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    if (enumerableOnly) symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    });\n    keys.push.apply(keys, symbols);\n  }\n  return keys;\n}\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n    if (i % 2) {\n      ownKeys(Object(source), true).forEach(function (key) {\n        _defineProperty(target, key, source[key]);\n      });\n    } else if (Object.getOwnPropertyDescriptors) {\n      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));\n    } else {\n      ownKeys(Object(source)).forEach(function (key) {\n        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n      });\n    }\n  }\n  return target;\n}\nfunction _slicedToArray(arr, i) {\n  return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest();\n}\nfunction _nonIterableRest() {\n  throw new TypeError(\"Invalid attempt to destructure non-iterable instance\");\n}\nfunction _iterableToArrayLimit(arr, i) {\n  if (!(Symbol.iterator in Object(arr) || Object.prototype.toString.call(arr) === \"[object Arguments]\")) {\n    return;\n  }\n  var _arr = [];\n  var _n = true;\n  var _d = false;\n  var _e = undefined;\n  try {\n    for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) {\n      _arr.push(_s.value);\n      if (i && _arr.length === i) break;\n    }\n  } catch (err) {\n    _d = true;\n    _e = err;\n  } finally {\n    try {\n      if (!_n && _i[\"return\"] != null) _i[\"return\"]();\n    } finally {\n      if (_d) throw _e;\n    }\n  }\n  return _arr;\n}\nfunction _arrayWithHoles(arr) {\n  if (Array.isArray(arr)) return arr;\n}\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\nfunction _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  return Constructor;\n}\nfunction _possibleConstructorReturn(self, call) {\n  if (call && (_typeof(call) === \"object\" || typeof call === \"function\")) {\n    return call;\n  }\n  return _assertThisInitialized(self);\n}\nfunction _getPrototypeOf(o) {\n  _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) {\n    return o.__proto__ || Object.getPrototypeOf(o);\n  };\n  return _getPrototypeOf(o);\n}\nfunction _assertThisInitialized(self) {\n  if (self === void 0) {\n    throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");\n  }\n  return self;\n}\nfunction _inherits(subClass, superClass) {\n  if (typeof superClass !== \"function\" && superClass !== null) {\n    throw new TypeError(\"Super expression must either be null or a function\");\n  }\n  subClass.prototype = Object.create(superClass && superClass.prototype, {\n    constructor: {\n      value: subClass,\n      writable: true,\n      configurable: true\n    }\n  });\n  if (superClass) _setPrototypeOf(subClass, superClass);\n}\nfunction _setPrototypeOf(o, p) {\n  _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) {\n    o.__proto__ = p;\n    return o;\n  };\n  return _setPrototypeOf(o, p);\n}\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n  return obj;\n}\n\n/**\n * \n * @file Versions Sidebar container\n * @author Box\n */\nimport React from 'react';\nimport flow from 'lodash/flow';\nimport getProp from 'lodash/get';\nimport merge from 'lodash/merge';\nimport noop from 'lodash/noop';\nimport { generatePath, withRouter } from 'react-router-dom';\nimport API from '../../../api';\nimport messages from './messages';\nimport openUrlInsideIframe from '../../../utils/iframe';\nimport VersionsSidebar from './VersionsSidebar';\nimport VersionsSidebarAPI from './VersionsSidebarAPI';\nimport { withAPIContext } from '../../common/api-context';\nvar VersionsSidebarContainer = /*#__PURE__*/\nfunction (_React$Component) {\n  _inherits(VersionsSidebarContainer, _React$Component);\n  function VersionsSidebarContainer() {\n    var _getPrototypeOf2;\n    var _this;\n    _classCallCheck(this, VersionsSidebarContainer);\n    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n      args[_key] = arguments[_key];\n    }\n    _this = _possibleConstructorReturn(this, (_getPrototypeOf2 = _getPrototypeOf(VersionsSidebarContainer)).call.apply(_getPrototypeOf2, [this].concat(args)));\n    _defineProperty(_assertThisInitialized(_this), \"state\", {\n      isLoading: true,\n      isWatermarked: false,\n      versionCount: Infinity,\n      versionLimit: Infinity,\n      versions: []\n    });\n    _defineProperty(_assertThisInitialized(_this), \"window\", window);\n    _defineProperty(_assertThisInitialized(_this), \"handleActionDelete\", function (versionId) {\n      _this.setState({\n        isLoading: true\n      });\n      return _this.api.deleteVersion(_this.findVersion(versionId)).then(function () {\n        return _this.api.fetchVersion(versionId);\n      }).then(_this.handleDeleteSuccess).then(function () {\n        return _this.props.onVersionDelete(versionId);\n      }).catch(function () {\n        return _this.handleActionError(messages.versionActionDeleteError);\n      });\n    });\n    _defineProperty(_assertThisInitialized(_this), \"handleActionDownload\", function (versionId) {\n      return _this.api.fetchDownloadUrl(_this.findVersion(versionId)).then(openUrlInsideIframe).then(function () {\n        return _this.props.onVersionDownload(versionId);\n      }).catch(function () {\n        return _this.handleActionError(messages.versionActionDownloadError);\n      });\n    });\n    _defineProperty(_assertThisInitialized(_this), \"handleActionPreview\", function (versionId) {\n      _this.updateVersion(versionId);\n      _this.props.onVersionPreview(versionId);\n    });\n    _defineProperty(_assertThisInitialized(_this), \"handleActionPromote\", function (versionId) {\n      _this.setState({\n        isLoading: true\n      });\n      return _this.api.promoteVersion(_this.findVersion(versionId)).then(_this.api.fetchData).then(_this.handleFetchSuccess).then(_this.handlePromoteSuccess).then(function () {\n        return _this.props.onVersionPromote(versionId);\n      }).catch(function () {\n        return _this.handleActionError(messages.versionActionPromoteError);\n      });\n    });\n    _defineProperty(_assertThisInitialized(_this), \"handleActionRestore\", function (versionId) {\n      _this.setState({\n        isLoading: true\n      });\n      return _this.api.restoreVersion(_this.findVersion(versionId)).then(function () {\n        return _this.api.fetchVersion(versionId);\n      }).then(_this.handleRestoreSuccess).then(function () {\n        return _this.props.onVersionRestore(versionId);\n      }).catch(function () {\n        return _this.handleActionError(messages.versionActionRestoreError);\n      });\n    });\n    _defineProperty(_assertThisInitialized(_this), \"handleActionError\", function (message) {\n      _this.setState({\n        error: message,\n        isLoading: false\n      });\n    });\n    _defineProperty(_assertThisInitialized(_this), \"handleDeleteSuccess\", function (data) {\n      var selectedVersionId = _this.props.versionId;\n      var versionId = data.id;\n      _this.mergeResponse(data); // Bump the user to the current version if they deleted their selected version\n\n      if (versionId === selectedVersionId) {\n        _this.updateVersionToCurrent();\n      }\n    });\n    _defineProperty(_assertThisInitialized(_this), \"handleRestoreSuccess\", function (data) {\n      _this.mergeResponse(data);\n    });\n    _defineProperty(_assertThisInitialized(_this), \"handleFetchError\", function () {\n      _this.setState({\n        error: messages.versionFetchError,\n        isLoading: false,\n        isWatermarked: false,\n        versionCount: 0,\n        versions: []\n      });\n    });\n    _defineProperty(_assertThisInitialized(_this), \"handleFetchSuccess\", function (_ref) {\n      var _ref2 = _slicedToArray(_ref, 2),\n        fileResponse = _ref2[0],\n        versionsResponse = _ref2[1];\n      var api = _this.props.api;\n      var version_limit = fileResponse.version_limit;\n      var isWatermarked = getProp(fileResponse, 'watermark_info.is_watermarked', false);\n      var versionLimit = version_limit !== null && version_limit !== undefined ? version_limit : Infinity;\n      var versionsWithPermissions = api.getVersionsAPI(false).addPermissions(versionsResponse, fileResponse) || {};\n      var versions = versionsWithPermissions.entries,\n        versionCount = versionsWithPermissions.total_count;\n      _this.setState({\n        error: undefined,\n        isLoading: false,\n        isWatermarked: isWatermarked,\n        versionCount: versionCount,\n        versionLimit: versionLimit,\n        versions: _this.sortVersions(versions)\n      }, _this.verifyVersion);\n      return [fileResponse, versionsResponse];\n    });\n    _defineProperty(_assertThisInitialized(_this), \"handlePromoteSuccess\", function (_ref3) {\n      var _ref4 = _slicedToArray(_ref3, 1),\n        file = _ref4[0];\n      var fileVersion = file.file_version;\n      if (fileVersion) {\n        _this.updateVersion(fileVersion.id);\n      }\n    });\n    _defineProperty(_assertThisInitialized(_this), \"initialize\", function () {\n      _this.api = new VersionsSidebarAPI(_this.props);\n    });\n    _defineProperty(_assertThisInitialized(_this), \"fetchData\", function () {\n      _this.api.fetchData().then(_this.handleFetchSuccess).catch(_this.handleFetchError);\n    });\n    _defineProperty(_assertThisInitialized(_this), \"findVersion\", function (versionId) {\n      var versions = _this.state.versions;\n      return versions.find(function (version) {\n        return version.id === versionId;\n      });\n    });\n    _defineProperty(_assertThisInitialized(_this), \"getCurrentVersionId\", function () {\n      var versions = _this.state.versions;\n      return versions[0] ? versions[0].id : null;\n    });\n    _defineProperty(_assertThisInitialized(_this), \"mergeVersions\", function (newVersion) {\n      var versions = _this.state.versions;\n      var newVersionId = newVersion ? newVersion.id : '';\n      return versions.map(function (version) {\n        return version.id === newVersionId ? merge(_objectSpread({}, version), newVersion) : version;\n      });\n    });\n    _defineProperty(_assertThisInitialized(_this), \"mergeResponse\", function (data) {\n      var newVersions = _this.mergeVersions(data);\n      _this.setState({\n        error: undefined,\n        isLoading: false,\n        versions: newVersions\n      });\n    });\n    _defineProperty(_assertThisInitialized(_this), \"updateVersion\", function (versionId) {\n      var _this$props = _this.props,\n        history = _this$props.history,\n        match = _this$props.match;\n      return history.push(generatePath(match.path, _objectSpread({}, match.params, {\n        versionId: versionId\n      })));\n    });\n    _defineProperty(_assertThisInitialized(_this), \"updateVersionToCurrent\", function () {\n      _this.updateVersion(_this.getCurrentVersionId());\n    });\n    _defineProperty(_assertThisInitialized(_this), \"verifyVersion\", function () {\n      var _this$props2 = _this.props,\n        onVersionChange = _this$props2.onVersionChange,\n        versionId = _this$props2.versionId;\n      var selectedVersion = _this.findVersion(versionId);\n      if (selectedVersion) {\n        onVersionChange(selectedVersion, {\n          currentVersionId: _this.getCurrentVersionId(),\n          updateVersionToCurrent: _this.updateVersionToCurrent\n        });\n      } else {\n        _this.updateVersionToCurrent();\n      }\n    });\n    return _this;\n  }\n  _createClass(VersionsSidebarContainer, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      this.initialize();\n      this.fetchData();\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate(_ref5) {\n      var prevFileId = _ref5.fileId,\n        prevVersionId = _ref5.versionId;\n      var _this$props3 = this.props,\n        fileId = _this$props3.fileId,\n        versionId = _this$props3.versionId;\n      if (fileId !== prevFileId) {\n        this.refresh();\n      }\n      if (versionId !== prevVersionId) {\n        this.verifyVersion();\n      }\n    }\n  }, {\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      // Reset the current version id since the wrapping route is no longer active\n      this.props.onVersionChange(null);\n    }\n  }, {\n    key: \"refresh\",\n    value: function refresh() {\n      this.initialize();\n      this.setState({\n        isLoading: true\n      }, this.fetchData);\n    }\n  }, {\n    key: \"sortVersions\",\n    value: function sortVersions() {\n      var versions = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];\n      return _toConsumableArray(versions).sort(function (a, b) {\n        return Date.parse(b.created_at) - Date.parse(a.created_at);\n      });\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this$props4 = this.props,\n        fileId = _this$props4.fileId,\n        parentName = _this$props4.parentName;\n      return React.createElement(VersionsSidebar, _extends({\n        fileId: fileId,\n        onDelete: this.handleActionDelete,\n        onDownload: this.handleActionDownload,\n        onPreview: this.handleActionPreview,\n        onPromote: this.handleActionPromote,\n        onRestore: this.handleActionRestore,\n        parentName: parentName\n      }, this.state));\n    }\n  }]);\n  return VersionsSidebarContainer;\n}(React.Component);\n_defineProperty(VersionsSidebarContainer, \"defaultProps\", {\n  onVersionChange: noop,\n  onVersionDelete: noop,\n  onVersionDownload: noop,\n  onVersionPreview: noop,\n  onVersionPromote: noop,\n  onVersionRestore: noop,\n  parentName: ''\n});\nexport default flow([withRouter, withAPIContext])(VersionsSidebarContainer);","map":{"version":3,"sources":["../../../../src/elements/content-sidebar/versions/VersionsSidebarContainer.js"],"names":["React","flow","getProp","merge","noop","generatePath","withRouter","API","messages","openUrlInsideIframe","VersionsSidebar","VersionsSidebarAPI","withAPIContext","VersionsSidebarContainer","Component","onVersionChange","onVersionDelete","onVersionDownload","onVersionPreview","onVersionPromote","onVersionRestore","parentName","isLoading","isWatermarked","versionCount","Infinity","versionLimit","versions","window","initialize","fetchData","fileId","prevFileId","versionId","prevVersionId","props","refresh","verifyVersion","setState","api","deleteVersion","findVersion","then","fetchVersion","handleDeleteSuccess","catch","handleActionError","versionActionDeleteError","fetchDownloadUrl","versionActionDownloadError","updateVersion","promoteVersion","handleFetchSuccess","handlePromoteSuccess","versionActionPromoteError","restoreVersion","handleRestoreSuccess","versionActionRestoreError","message","error","data","selectedVersionId","id","mergeResponse","updateVersionToCurrent","versionFetchError","fileResponse","versionsResponse","version_limit","undefined","versionsWithPermissions","getVersionsAPI","addPermissions","entries","total_count","sortVersions","file","file_version","fileVersion","handleFetchError","state","find","version","newVersion","newVersionId","map","newVersions","mergeVersions","sort","a","b","Date","parse","created_at","history","match","push","path","params","getCurrentVersionId","selectedVersion","currentVersionId","handleActionDelete","handleActionDownload","handleActionPreview","handleActionPromote","handleActionRestore"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;;;;AAMA,OAAOA,KAAP,MAAkB,OAAlB;AACA,OAAOC,IAAP,MAAiB,aAAjB;AACA,OAAOC,OAAP,MAAoB,YAApB;AACA,OAAOC,KAAP,MAAkB,cAAlB;AACA,OAAOC,IAAP,MAAiB,aAAjB;AACA,SAASC,YAAT,EAAuBC,UAAvB,QAAyC,kBAAzC;AAGA,OAAOC,GAAP,MAAgB,cAAhB;AACA,OAAOC,QAAP,MAAqB,YAArB;AACA,OAAOC,mBAAP,MAAgC,uBAAhC;AACA,OAAOC,eAAP,MAA4B,mBAA5B;AACA,OAAOC,kBAAP,MAA+B,sBAA/B;AACA,SAASC,cAAT,QAA+B,0BAA/B;IA6BMC,wB;;;;;;;;;;;4DAea;MACXS,SAAS,EAAE,IADA;MAEXC,aAAa,EAAE,KAFJ;MAGXC,YAAY,EAAEC,QAHH;MAIXC,YAAY,EAAED,QAJH;MAKXE,QAAQ,EAAE;IALC,C;6DAQDC,M;yEAwBO,UAACK,SAAD,EAAsC;MACvD,KAAA,CAAKK,QAAL,CAAc;QAAEhB,SAAS,EAAE;MAAb,CAAd,CAAA;MAEA,OAAO,KAAA,CAAKiB,GAAL,CACFC,aADE,CACY,KAAA,CAAKC,WAAL,CAAiBR,SAAjB,CADZ,CAAA,CAEFS,IAFE,CAEG,YAAA;QAAA,OAAM,KAAA,CAAKH,GAAL,CAASI,YAAT,CAAsBV,SAAtB,CAAN;MAAA,CAFH,CAAA,CAGFS,IAHE,CAGG,KAAA,CAAKE,mBAHR,CAAA,CAIFF,IAJE,CAIG,YAAA;QAAA,OAAM,KAAA,CAAKP,KAAL,CAAWnB,eAAX,CAA2BiB,SAA3B,CAAN;MAAA,CAJH,CAAA,CAKFY,KALE,CAKI,YAAA;QAAA,OAAM,KAAA,CAAKC,iBAAL,CAAuBtC,QAAQ,CAACuC,wBAAhC,CAAN;MAAA,CALJ,CAAP;IAMH,C;2EAEsB,UAACd,SAAD,EAAsC;MACzD,OAAO,KAAA,CAAKM,GAAL,CACFS,gBADE,CACe,KAAA,CAAKP,WAAL,CAAiBR,SAAjB,CADf,CAAA,CAEFS,IAFE,CAEGjC,mBAFH,CAAA,CAGFiC,IAHE,CAGG,YAAA;QAAA,OAAM,KAAA,CAAKP,KAAL,CAAWlB,iBAAX,CAA6BgB,SAA7B,CAAN;MAAA,CAHH,CAAA,CAIFY,KAJE,CAII,YAAA;QAAA,OAAM,KAAA,CAAKC,iBAAL,CAAuBtC,QAAQ,CAACyC,0BAAhC,CAAN;MAAA,CAJJ,CAAP;IAKH,C;0EAEqB,UAAChB,SAAD,EAA6B;MAC/C,KAAA,CAAKiB,aAAL,CAAmBjB,SAAnB,CAAA;MACA,KAAA,CAAKE,KAAL,CAAWjB,gBAAX,CAA4Be,SAA5B,CAAA;IACH,C;0EAEqB,UAACA,SAAD,EAAsC;MACxD,KAAA,CAAKK,QAAL,CAAc;QAAEhB,SAAS,EAAE;MAAb,CAAd,CAAA;MAEA,OAAO,KAAA,CAAKiB,GAAL,CACFY,cADE,CACa,KAAA,CAAKV,WAAL,CAAiBR,SAAjB,CADb,CAAA,CAEFS,IAFE,CAEG,KAAA,CAAKH,GAAL,CAAST,SAFZ,CAAA,CAGFY,IAHE,CAGG,KAAA,CAAKU,kBAHR,CAAA,CAIFV,IAJE,CAIG,KAAA,CAAKW,oBAJR,CAAA,CAKFX,IALE,CAKG,YAAA;QAAA,OAAM,KAAA,CAAKP,KAAL,CAAWhB,gBAAX,CAA4Bc,SAA5B,CAAN;MAAA,CALH,CAAA,CAMFY,KANE,CAMI,YAAA;QAAA,OAAM,KAAA,CAAKC,iBAAL,CAAuBtC,QAAQ,CAAC8C,yBAAhC,CAAN;MAAA,CANJ,CAAP;IAOH,C;0EAEqB,UAACrB,SAAD,EAAsC;MACxD,KAAA,CAAKK,QAAL,CAAc;QAAEhB,SAAS,EAAE;MAAb,CAAd,CAAA;MAEA,OAAO,KAAA,CAAKiB,GAAL,CACFgB,cADE,CACa,KAAA,CAAKd,WAAL,CAAiBR,SAAjB,CADb,CAAA,CAEFS,IAFE,CAEG,YAAA;QAAA,OAAM,KAAA,CAAKH,GAAL,CAASI,YAAT,CAAsBV,SAAtB,CAAN;MAAA,CAFH,CAAA,CAGFS,IAHE,CAGG,KAAA,CAAKc,oBAHR,CAAA,CAIFd,IAJE,CAIG,YAAA;QAAA,OAAM,KAAA,CAAKP,KAAL,CAAWf,gBAAX,CAA4Ba,SAA5B,CAAN;MAAA,CAJH,CAAA,CAKFY,KALE,CAKI,YAAA;QAAA,OAAM,KAAA,CAAKC,iBAAL,CAAuBtC,QAAQ,CAACiD,yBAAhC,CAAN;MAAA,CALJ,CAAP;IAMH,C;wEAEmB,UAACC,OAAD,EAAsC;MACtD,KAAA,CAAKpB,QAAL,CAAc;QACVqB,KAAK,EAAED,OADG;QAEVpC,SAAS,EAAE;MAFD,CAAd,CAAA;IAIH,C;0EAEqB,UAACsC,IAAD,EAAgC;MAAA,IAC/BC,iBAD+B,GACT,KAAA,CAAK1B,KADI,CAC1CF,SAD0C;MAAA,IAEtCA,SAFsC,GAExB2B,IAFwB,CAE1CE,EAF0C;MAIlD,KAAA,CAAKC,aAAL,CAAmBH,IAAnB,CAAA,CAJkD,CAMlD;;MACA,IAAI3B,SAAS,KAAK4B,iBAAlB,EAAqC;QACjC,KAAA,CAAKG,sBAAL,CAAA,CAAA;MACH;IACJ,C;2EAEsB,UAACJ,IAAD,EAAgC;MACnD,KAAA,CAAKG,aAAL,CAAmBH,IAAnB,CAAA;IACH,C;uEAEkB,YAAY;MAC3B,KAAA,CAAKtB,QAAL,CAAc;QACVqB,KAAK,EAAEnD,QAAQ,CAACyD,iBADN;QAEV3C,SAAS,EAAE,KAFD;QAGVC,aAAa,EAAE,KAHL;QAIVC,YAAY,EAAE,CAJJ;QAKVG,QAAQ,EAAE;MALA,CAAd,CAAA;IAOH,C;yEAEoB,UAAA,IAAA,EAA+D;MAAA,IAAA,KAAA,GAAA,cAAA,CAAA,IAAA,EAAA,CAAA,CAAA;QAA7DuC,YAA6D,GAAA,KAAA,CAAA,CAAA,CAAA;QAA/CC,gBAA+C,GAAA,KAAA,CAAA,CAAA,CAAA;MAAA,IACxE5B,GADwE,GAChE,KAAA,CAAKJ,KAD2D,CACxEI,GADwE;MAAA,IAExE6B,aAFwE,GAEtDF,YAFsD,CAExEE,aAFwE;MAGhF,IAAM7C,aAAa,GAAGrB,OAAO,CAACgE,YAAD,EAAe,+BAAf,EAAgD,KAAhD,CAA7B;MACA,IAAMxC,YAAY,GAAG0C,aAAa,KAAK,IAAlBA,IAA0BA,aAAa,KAAKC,SAA5CD,GAAwDA,aAAxDA,GAAwE3C,QAA7F;MACA,IAAM6C,uBAAuB,GAAG/B,GAAG,CAACgC,cAAJhC,CAAmB,KAAnBA,CAAAA,CAA0BiC,cAA1BjC,CAAyC4B,gBAAzC5B,EAA2D2B,YAA3D3B,CAAAA,IAA4E,CAAA,CAA5G;MALgF,IAM/DZ,QAN+D,GAMvB2C,uBANuB,CAMxEG,OANwE;QAMxCjD,YANwC,GAMvB8C,uBANuB,CAMrDI,WANqD;MAQhF,KAAA,CAAKpC,QAAL,CACI;QACIqB,KAAK,EAAEU,SADX;QAEI/C,SAAS,EAAE,KAFf;QAGIC,aAAa,EAAbA,aAHJ;QAIIC,YAAY,EAAZA,YAJJ;QAKIE,YAAY,EAAZA,YALJ;QAMIC,QAAQ,EAAE,KAAA,CAAKgD,YAAL,CAAkBhD,QAAlB;MANd,CADJ,EASI,KAAA,CAAKU,aATT,CAAA;MAYA,OAAO,CAAC6B,YAAD,EAAeC,gBAAf,CAAP;IACH,C;2EAEsB,UAAA,KAAA,EAA2C;MAAA,IAAA,KAAA,GAAA,cAAA,CAAA,KAAA,EAAA,CAAA,CAAA;QAAzCS,IAAyC,GAAA,KAAA,CAAA,CAAA,CAAA;MAAA,IACxCE,WADwC,GACxBF,IADwB,CACtDC,YADsD;MAG9D,IAAIC,WAAJ,EAAiB;QACb,KAAA,CAAK5B,aAAL,CAAmB4B,WAAW,CAAChB,EAA/B,CAAA;MACH;IACJ,C;iEAEY,YAAY;MACrB,KAAA,CAAKvB,GAAL,GAAW,IAAI5B,kBAAJ,CAAuB,KAAA,CAAKwB,KAA5B,CAAX;IACH,C;gEAEW,YAAY;MACpB,KAAA,CAAKI,GAAL,CACKT,SADL,CAAA,CAAA,CAEKY,IAFL,CAEU,KAAA,CAAKU,kBAFf,CAAA,CAGKP,KAHL,CAGW,KAAA,CAAKkC,gBAHhB,CAAA;IAIH,C;kEAEa,UAAC9C,SAAD,EAAyC;MAAA,IAC3CN,QAD2C,GAC9B,KAAA,CAAKqD,KADyB,CAC3CrD,QAD2C;MAGnD,OAAO,QAAQ,CAACsD,IAAT,CAAc,UAAA,OAAO,EAAA;QAAA,OAAIC,OAAO,CAACpB,EAARoB,KAAejD,SAAnB;MAAA,CAArB,CAAP;IACH,C;0EAEqB,YAAe;MAAA,IACzBN,QADyB,GACZ,KAAA,CAAKqD,KADO,CACzBrD,QADyB;MAEjC,OAAOA,QAAQ,CAAC,CAAD,CAARA,GAAcA,QAAQ,CAAC,CAAD,CAARA,CAAYmC,EAA1BnC,GAA+B,IAAtC;IACH,C;oEAEe,UAACwD,UAAD,EAAuD;MAAA,IAC3DxD,QAD2D,GAC9C,KAAA,CAAKqD,KADyC,CAC3DrD,QAD2D;MAEnE,IAAMyD,YAAY,GAAGD,UAAU,GAAGA,UAAU,CAACrB,EAAd,GAAmB,EAAlD;MACA,OAAO,QAAQ,CAACuB,GAAT,CAAa,UAAA,OAAO,EAAA;QAAA,OAAKH,OAAO,CAACpB,EAARoB,KAAeE,YAAfF,GAA8B/E,KAAK,CAAA,aAAA,CAAA,CAAA,CAAA,EAAM+E,OAAN,CAAA,EAAiBC,UAAjB,CAAnCD,GAAkEA,OAAvE;MAAA,CAApB,CAAP;IACH,C;oEAEe,UAACtB,IAAD,EAAgC;MAC5C,IAAM0B,WAAW,GAAG,KAAA,CAAKC,aAAL,CAAmB3B,IAAnB,CAApB;MAEA,KAAA,CAAKtB,QAAL,CAAc;QACVqB,KAAK,EAAEU,SADG;QAEV/C,SAAS,EAAE,KAFD;QAGVK,QAAQ,EAAE2D;MAHA,CAAd,CAAA;IAKH,C;oEAWe,UAACrD,SAAD,EAA+B;MAAA,IAAA,WAAA,GAChB,KAAA,CAAKE,KADW;QACnC2D,OADmC,GAAA,WAAA,CACnCA,OADmC;QAC1BC,KAD0B,GAAA,WAAA,CAC1BA,KAD0B;MAE3C,OAAO,OAAO,CAACC,IAAR,CAAa3F,YAAY,CAAC0F,KAAK,CAACE,IAAP,EAAA,aAAA,CAAA,CAAA,CAAA,EAAkBF,KAAK,CAACG,MAAxB,EAAA;QAAgCjE,SAAS,EAATA;MAAhC,CAAA,CAAA,CAAzB,CAAP;IACH,C;6EAEwB,YAAY;MACjC,KAAA,CAAKiB,aAAL,CAAmB,KAAA,CAAKiD,mBAAL,CAAA,CAAnB,CAAA;IACH,C;oEAEe,YAAM;MAAA,IAAA,YAAA,GACqB,KAAA,CAAKhE,KAD1B;QACVpB,eADU,GAAA,YAAA,CACVA,eADU;QACOkB,SADP,GAAA,YAAA,CACOA,SADP;MAElB,IAAMmE,eAAe,GAAG,KAAA,CAAK3D,WAAL,CAAiBR,SAAjB,CAAxB;MAEA,IAAImE,eAAJ,EAAqB;QACjBrF,eAAe,CAACqF,eAAD,EAAkB;UAC7BC,gBAAgB,EAAE,KAAA,CAAKF,mBAAL,CAAA,CADW;UAE7BnC,sBAAsB,EAAE,KAAA,CAAKA;QAFA,CAAlB,CAAfjD;MAIH,CALD,MAKO;QACH,KAAA,CAAKiD,sBAAL,CAAA,CAAA;MACH;IACJ,C;;;;;wCAzMmB;MAChB,IAAA,CAAKnC,UAAL,CAAA,CAAA;MACA,IAAA,CAAKC,SAAL,CAAA,CAAA;IACH;;;8CAE2E;MAAA,IAA/CE,UAA+C,GAAA,KAAA,CAAvDD,MAAuD;QAAxBG,aAAwB,GAAA,KAAA,CAAnCD,SAAmC;MAAA,IAAA,YAAA,GAC1C,IAAA,CAAKE,KADqC;QAChEJ,MADgE,GAAA,YAAA,CAChEA,MADgE;QACxDE,SADwD,GAAA,YAAA,CACxDA,SADwD;MAGxE,IAAIF,MAAM,KAAKC,UAAf,EAA2B;QACvB,IAAA,CAAKI,OAAL,CAAA,CAAA;MACH;MAED,IAAIH,SAAS,KAAKC,aAAlB,EAAiC;QAC7B,IAAA,CAAKG,aAAL,CAAA,CAAA;MACH;IACJ;;;2CAEsB;MACnB;MACA,IAAA,CAAKF,KAAL,CAAWpB,eAAX,CAA2B,IAA3B,CAAA;IACH;;;8BAuJe;MACZ,IAAA,CAAKc,UAAL,CAAA,CAAA;MACA,IAAA,CAAKS,QAAL,CAAc;QAAEhB,SAAS,EAAE;MAAb,CAAd,EAAmC,IAAA,CAAKQ,SAAxC,CAAA;IACH;;;mCAE0E;MAAA,IAA9DH,QAA8D,GAAA,SAAA,CAAA,MAAA,GAAA,CAAA,IAAA,SAAA,CAAA,CAAA,CAAA,KAAA,SAAA,GAAA,SAAA,CAAA,CAAA,CAAA,GAA3B,EAA2B;MACvE,OAAO,kBAAA,CAAIA,QAAJ,CAAA,CAAc6D,IAAd,CAAmB,UAACC,CAAD,EAAIC,CAAJ,EAAA;QAAA,OAAUC,IAAI,CAACC,KAALD,CAAWD,CAAC,CAACG,UAAbF,CAAAA,GAA2BA,IAAI,CAACC,KAALD,CAAWF,CAAC,CAACI,UAAbF,CAArC;MAAA,CAAnB,CAAP;IACH;;;6BAyBQ;MAAA,IAAA,YAAA,GAC0B,IAAA,CAAKxD,KAD/B;QACGJ,MADH,GAAA,YAAA,CACGA,MADH;QACWV,UADX,GAAA,YAAA,CACWA,UADX;MAGL,OACI,KAAA,CAAA,aAAA,CAAC,eAAD,EAAA,QAAA,CAAA;QACI,MAAM,EAAEU,MADZ;QAEI,QAAQ,EAAE,IAAA,CAAKuE,kBAFnB;QAGI,UAAU,EAAE,IAAA,CAAKC,oBAHrB;QAII,SAAS,EAAE,IAAA,CAAKC,mBAJpB;QAKI,SAAS,EAAE,IAAA,CAAKC,mBALpB;QAMI,SAAS,EAAE,IAAA,CAAKC,mBANpB;QAOI,UAAU,EAAErF;MAPhB,CAAA,EAQQ,IAAA,CAAK2D,KARb,CAAA,CADJ;IAYH;;;EAnPkChF,KAAK,CAACc,S;gBAAvCD,wB,kBACoB;EAClBE,eAAe,EAAEX,IADC;EAElBY,eAAe,EAAEZ,IAFC;EAGlBa,iBAAiB,EAAEb,IAHD;EAIlBc,gBAAgB,EAAEd,IAJA;EAKlBe,gBAAgB,EAAEf,IALA;EAMlBgB,gBAAgB,EAAEhB,IANA;EAOlBiB,UAAU,EAAE;AAPM,C;AAsP1B,eAAepB,IAAI,CAAC,CAACK,UAAD,EAAaM,cAAb,CAAD,CAAJX,CAAmCY,wBAAnCZ,CAAf","sourcesContent":["/**\n * @flow\n * @file Versions Sidebar container\n * @author Box\n */\n\nimport React from 'react';\nimport flow from 'lodash/flow';\nimport getProp from 'lodash/get';\nimport merge from 'lodash/merge';\nimport noop from 'lodash/noop';\nimport { generatePath, withRouter } from 'react-router-dom';\nimport type { Match, RouterHistory } from 'react-router-dom';\nimport type { MessageDescriptor } from 'react-intl';\nimport API from '../../../api';\nimport messages from './messages';\nimport openUrlInsideIframe from '../../../utils/iframe';\nimport VersionsSidebar from './VersionsSidebar';\nimport VersionsSidebarAPI from './VersionsSidebarAPI';\nimport { withAPIContext } from '../../common/api-context';\nimport type { VersionActionCallback, VersionChangeCallback } from './flowTypes';\nimport type { BoxItemVersion, BoxItem, FileVersions } from '../../../common/types/core';\n\ntype Props = {\n    api: API,\n    fileId: string,\n    hasSidebarInitialized?: boolean,\n    history: RouterHistory,\n    match: Match,\n    onVersionChange: VersionChangeCallback,\n    onVersionDelete: VersionActionCallback,\n    onVersionDownload: VersionActionCallback,\n    onVersionPreview: VersionActionCallback,\n    onVersionPromote: VersionActionCallback,\n    onVersionRestore: VersionActionCallback,\n    parentName: string,\n    versionId?: string,\n};\n\ntype State = {\n    error?: MessageDescriptor,\n    isLoading: boolean,\n    isWatermarked: boolean,\n    versionCount: number,\n    versionLimit: number,\n    versions: Array<BoxItemVersion>,\n};\n\nclass VersionsSidebarContainer extends React.Component<Props, State> {\n    static defaultProps = {\n        onVersionChange: noop,\n        onVersionDelete: noop,\n        onVersionDownload: noop,\n        onVersionPreview: noop,\n        onVersionPromote: noop,\n        onVersionRestore: noop,\n        parentName: '',\n    };\n\n    api: VersionsSidebarAPI;\n\n    props: Props;\n\n    state: State = {\n        isLoading: true,\n        isWatermarked: false,\n        versionCount: Infinity,\n        versionLimit: Infinity,\n        versions: [],\n    };\n\n    window: any = window;\n\n    componentDidMount() {\n        this.initialize();\n        this.fetchData();\n    }\n\n    componentDidUpdate({ fileId: prevFileId, versionId: prevVersionId }: Props) {\n        const { fileId, versionId } = this.props;\n\n        if (fileId !== prevFileId) {\n            this.refresh();\n        }\n\n        if (versionId !== prevVersionId) {\n            this.verifyVersion();\n        }\n    }\n\n    componentWillUnmount() {\n        // Reset the current version id since the wrapping route is no longer active\n        this.props.onVersionChange(null);\n    }\n\n    handleActionDelete = (versionId: string): Promise<void> => {\n        this.setState({ isLoading: true });\n\n        return this.api\n            .deleteVersion(this.findVersion(versionId))\n            .then(() => this.api.fetchVersion(versionId))\n            .then(this.handleDeleteSuccess)\n            .then(() => this.props.onVersionDelete(versionId))\n            .catch(() => this.handleActionError(messages.versionActionDeleteError));\n    };\n\n    handleActionDownload = (versionId: string): Promise<void> => {\n        return this.api\n            .fetchDownloadUrl(this.findVersion(versionId))\n            .then(openUrlInsideIframe)\n            .then(() => this.props.onVersionDownload(versionId))\n            .catch(() => this.handleActionError(messages.versionActionDownloadError));\n    };\n\n    handleActionPreview = (versionId: string): void => {\n        this.updateVersion(versionId);\n        this.props.onVersionPreview(versionId);\n    };\n\n    handleActionPromote = (versionId: string): Promise<void> => {\n        this.setState({ isLoading: true });\n\n        return this.api\n            .promoteVersion(this.findVersion(versionId))\n            .then(this.api.fetchData)\n            .then(this.handleFetchSuccess)\n            .then(this.handlePromoteSuccess)\n            .then(() => this.props.onVersionPromote(versionId))\n            .catch(() => this.handleActionError(messages.versionActionPromoteError));\n    };\n\n    handleActionRestore = (versionId: string): Promise<void> => {\n        this.setState({ isLoading: true });\n\n        return this.api\n            .restoreVersion(this.findVersion(versionId))\n            .then(() => this.api.fetchVersion(versionId))\n            .then(this.handleRestoreSuccess)\n            .then(() => this.props.onVersionRestore(versionId))\n            .catch(() => this.handleActionError(messages.versionActionRestoreError));\n    };\n\n    handleActionError = (message: MessageDescriptor): void => {\n        this.setState({\n            error: message,\n            isLoading: false,\n        });\n    };\n\n    handleDeleteSuccess = (data: BoxItemVersion): void => {\n        const { versionId: selectedVersionId } = this.props;\n        const { id: versionId } = data;\n\n        this.mergeResponse(data);\n\n        // Bump the user to the current version if they deleted their selected version\n        if (versionId === selectedVersionId) {\n            this.updateVersionToCurrent();\n        }\n    };\n\n    handleRestoreSuccess = (data: BoxItemVersion): void => {\n        this.mergeResponse(data);\n    };\n\n    handleFetchError = (): void => {\n        this.setState({\n            error: messages.versionFetchError,\n            isLoading: false,\n            isWatermarked: false,\n            versionCount: 0,\n            versions: [],\n        });\n    };\n\n    handleFetchSuccess = ([fileResponse, versionsResponse]): [BoxItem, FileVersions] => {\n        const { api } = this.props;\n        const { version_limit } = fileResponse;\n        const isWatermarked = getProp(fileResponse, 'watermark_info.is_watermarked', false);\n        const versionLimit = version_limit !== null && version_limit !== undefined ? version_limit : Infinity;\n        const versionsWithPermissions = api.getVersionsAPI(false).addPermissions(versionsResponse, fileResponse) || {};\n        const { entries: versions, total_count: versionCount } = versionsWithPermissions;\n\n        this.setState(\n            {\n                error: undefined,\n                isLoading: false,\n                isWatermarked,\n                versionCount,\n                versionLimit,\n                versions: this.sortVersions(versions),\n            },\n            this.verifyVersion,\n        );\n\n        return [fileResponse, versionsResponse];\n    };\n\n    handlePromoteSuccess = ([file]: [BoxItem, FileVersions]): void => {\n        const { file_version: fileVersion } = file;\n\n        if (fileVersion) {\n            this.updateVersion(fileVersion.id);\n        }\n    };\n\n    initialize = (): void => {\n        this.api = new VersionsSidebarAPI(this.props);\n    };\n\n    fetchData = (): void => {\n        this.api\n            .fetchData()\n            .then(this.handleFetchSuccess)\n            .catch(this.handleFetchError);\n    };\n\n    findVersion = (versionId: ?string): ?BoxItemVersion => {\n        const { versions } = this.state;\n\n        return versions.find(version => version.id === versionId);\n    };\n\n    getCurrentVersionId = (): ?string => {\n        const { versions } = this.state;\n        return versions[0] ? versions[0].id : null;\n    };\n\n    mergeVersions = (newVersion: BoxItemVersion): Array<BoxItemVersion> => {\n        const { versions } = this.state;\n        const newVersionId = newVersion ? newVersion.id : '';\n        return versions.map(version => (version.id === newVersionId ? merge({ ...version }, newVersion) : version));\n    };\n\n    mergeResponse = (data: BoxItemVersion): void => {\n        const newVersions = this.mergeVersions(data);\n\n        this.setState({\n            error: undefined,\n            isLoading: false,\n            versions: newVersions,\n        });\n    };\n\n    refresh(): void {\n        this.initialize();\n        this.setState({ isLoading: true }, this.fetchData);\n    }\n\n    sortVersions(versions?: Array<BoxItemVersion> = []): Array<BoxItemVersion> {\n        return [...versions].sort((a, b) => Date.parse(b.created_at) - Date.parse(a.created_at));\n    }\n\n    updateVersion = (versionId?: ?string): void => {\n        const { history, match } = this.props;\n        return history.push(generatePath(match.path, { ...match.params, versionId }));\n    };\n\n    updateVersionToCurrent = (): void => {\n        this.updateVersion(this.getCurrentVersionId());\n    };\n\n    verifyVersion = () => {\n        const { onVersionChange, versionId } = this.props;\n        const selectedVersion = this.findVersion(versionId);\n\n        if (selectedVersion) {\n            onVersionChange(selectedVersion, {\n                currentVersionId: this.getCurrentVersionId(),\n                updateVersionToCurrent: this.updateVersionToCurrent,\n            });\n        } else {\n            this.updateVersionToCurrent();\n        }\n    };\n\n    render() {\n        const { fileId, parentName } = this.props;\n\n        return (\n            <VersionsSidebar\n                fileId={fileId}\n                onDelete={this.handleActionDelete}\n                onDownload={this.handleActionDownload}\n                onPreview={this.handleActionPreview}\n                onPromote={this.handleActionPromote}\n                onRestore={this.handleActionRestore}\n                parentName={parentName}\n                {...this.state}\n            />\n        );\n    }\n}\n\nexport type VersionsSidebarProps = Props;\nexport default flow([withRouter, withAPIContext])(VersionsSidebarContainer);\n"]},"metadata":{},"sourceType":"module"}