{"ast":null,"code":"function _typeof(obj) {\n  \"@babel/helpers - typeof\";\n\n  if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") {\n    _typeof = function _typeof(obj) {\n      return typeof obj;\n    };\n  } else {\n    _typeof = function _typeof(obj) {\n      return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj;\n    };\n  }\n  return _typeof(obj);\n}\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\nfunction _possibleConstructorReturn(self, call) {\n  if (call && (_typeof(call) === \"object\" || typeof call === \"function\")) {\n    return call;\n  }\n  return _assertThisInitialized(self);\n}\nfunction _getPrototypeOf(o) {\n  _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) {\n    return o.__proto__ || Object.getPrototypeOf(o);\n  };\n  return _getPrototypeOf(o);\n}\nfunction _assertThisInitialized(self) {\n  if (self === void 0) {\n    throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");\n  }\n  return self;\n}\nfunction _inherits(subClass, superClass) {\n  if (typeof superClass !== \"function\" && superClass !== null) {\n    throw new TypeError(\"Super expression must either be null or a function\");\n  }\n  subClass.prototype = Object.create(superClass && superClass.prototype, {\n    constructor: {\n      value: subClass,\n      writable: true,\n      configurable: true\n    }\n  });\n  if (superClass) _setPrototypeOf(subClass, superClass);\n}\nfunction _setPrototypeOf(o, p) {\n  _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) {\n    o.__proto__ = p;\n    return o;\n  };\n  return _setPrototypeOf(o, p);\n}\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n  return obj;\n}\nimport Channel from './Channel';\nimport CONSTANTS from './constants';\nvar INPUT_EVENT = 'box_extension_input';\nvar OUTPUT_EVENT = 'box_extension_output';\nvar SafariChannel = /*#__PURE__*/\nfunction (_Channel) {\n  _inherits(SafariChannel, _Channel);\n  function SafariChannel(appName) {\n    var _this;\n    _classCallCheck(this, SafariChannel);\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(SafariChannel).call(this, appName));\n    _defineProperty(_assertThisInitialized(_this), \"executeOperation\", function () {\n      var operationType = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : '';\n      var data = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n      var browserToComServerTimeoutMS = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0;\n      var comServerToApplicationTimeoutSec = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 0;\n      return new Promise(function (resolve, reject) {\n        var details = _this.buildDetailsObj(operationType, data, comServerToApplicationTimeoutSec);\n        var timeoutId = setTimeout(function () {\n          reject(new Error({\n            status_code: CONSTANTS.REQUEST_TIMEOUT_RESPONSE_CODE\n          }));\n        }, browserToComServerTimeoutMS);\n        _this.reqIdToPromiseMap.set(details.req_id, {\n          resolve: resolve,\n          rejectTimeout: timeoutId\n        });\n        _this.createAndDispatchAppExtensionEvent({\n          detail: details\n        });\n      });\n    });\n    _defineProperty(_assertThisInitialized(_this), \"setupSafariExtensionCommunication\", function () {\n      if (!_this.isAppExtensionListenerAttached) {\n        _this.isAppExtensionListenerAttached = true;\n        _this.document.addEventListener(OUTPUT_EVENT, _this.appExtensionEventResponseHandler);\n      }\n    });\n    _defineProperty(_assertThisInitialized(_this), \"tearDownSafariExtensionCommunication\", function () {\n      if (_this.isAppExtensionListenerAttached) {\n        _this.isAppExtensionListenerAttached = false;\n        _this.document.removeEventListener(OUTPUT_EVENT, _this.appExtensionEventResponseHandler);\n      }\n    });\n    _defineProperty(_assertThisInitialized(_this), \"appExtensionEventResponseHandler\", function (responseVal) {\n      var response = typeof responseVal.detail === 'string' ? JSON.parse(responseVal.detail) : responseVal.detail;\n      if (_this.reqIdToPromiseMap.has(response.req_id)) {\n        var resolveObj = _this.reqIdToPromiseMap.get(response.req_id);\n        if (resolveObj) {\n          clearTimeout(resolveObj.rejectTimeout);\n          _this.reqIdToPromiseMap.delete(response.req_id);\n          var responseData = typeof response.com_server_response.data === 'string' ? JSON.parse(response.com_server_response.data) : response.com_server_response.data;\n          resolveObj.resolve(responseData);\n        }\n      }\n    });\n    _defineProperty(_assertThisInitialized(_this), \"createAndDispatchAppExtensionEvent\", function (payload) {\n      var CustomEvent = _this.window.CustomEvent;\n      var eventInstance = new CustomEvent(INPUT_EVENT, payload);\n      _this.document.dispatchEvent(eventInstance);\n    });\n    _defineProperty(_assertThisInitialized(_this), \"getComServerStatus\", function (browserToComServerTimeoutMS, comServerToApplicationTimeoutSec) {\n      return _this.executeOperation(CONSTANTS.OPERATION_STATUS, null, browserToComServerTimeoutMS, comServerToApplicationTimeoutSec);\n    });\n    _defineProperty(_assertThisInitialized(_this), \"sendRequest\", function (data, browserToComServerTimeoutMS, comServerToApplicationTimeoutSec) {\n      return _this.executeOperation(CONSTANTS.OPERATION_REQUEST, data, browserToComServerTimeoutMS, comServerToApplicationTimeoutSec);\n    });\n    _defineProperty(_assertThisInitialized(_this), \"sendCommand\", function (data, browserToComServerTimeoutMS, comServerToApplicationTimeoutSec) {\n      return _this.executeOperation(CONSTANTS.OPERATION_COMMAND, data, browserToComServerTimeoutMS, comServerToApplicationTimeoutSec);\n    });\n    _defineProperty(_assertThisInitialized(_this), \"destroy\", function () {\n      _this.tearDownSafariExtensionCommunication();\n    });\n    _this.reqIdToPromiseMap = new Map();\n    _this.channelName = CONSTANTS.SAFARI_CHANNEL_NAME;\n    _this.window = window;\n    _this.document = document;\n    _this.setupSafariExtensionCommunication();\n    return _this;\n  }\n  return SafariChannel;\n}(Channel);\nexport default SafariChannel;","map":{"version":3,"sources":["../../../src/api/box-edit/SafariChannel.js"],"names":["Channel","CONSTANTS","INPUT_EVENT","OUTPUT_EVENT","SafariChannel","appName","reqIdToPromiseMap","Map","channelName","SAFARI_CHANNEL_NAME","window","document","setupSafariExtensionCommunication","operationType","data","browserToComServerTimeoutMS","comServerToApplicationTimeoutSec","Promise","resolve","reject","details","buildDetailsObj","timeoutId","setTimeout","Error","status_code","REQUEST_TIMEOUT_RESPONSE_CODE","set","req_id","rejectTimeout","createAndDispatchAppExtensionEvent","detail","isAppExtensionListenerAttached","addEventListener","appExtensionEventResponseHandler","removeEventListener","responseVal","response","JSON","parse","has","resolveObj","get","clearTimeout","delete","responseData","com_server_response","payload","CustomEvent","eventInstance","dispatchEvent","executeOperation","OPERATION_STATUS","OPERATION_REQUEST","OPERATION_COMMAND","tearDownSafariExtensionCommunication"],"mappings":"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","sourcesContent":["// @flow\nimport Channel from './Channel';\nimport CONSTANTS from './constants';\n\nconst INPUT_EVENT = 'box_extension_input';\nconst OUTPUT_EVENT = 'box_extension_output';\n\nclass SafariChannel extends Channel {\n    isAppExtensionListenerAttached: boolean;\n\n    reqIdToPromiseMap: Map<string, Object>;\n\n    window: any;\n\n    document: Document;\n\n    constructor(appName: string) {\n        super(appName);\n        this.reqIdToPromiseMap = new Map();\n        this.channelName = CONSTANTS.SAFARI_CHANNEL_NAME;\n        this.window = window;\n        this.document = document;\n        this.setupSafariExtensionCommunication();\n    }\n\n    executeOperation = (\n        operationType: string = '',\n        data: ?Object = {},\n        browserToComServerTimeoutMS: number = 0,\n        comServerToApplicationTimeoutSec: number = 0,\n    ): Promise<any> => {\n        return new Promise((resolve, reject) => {\n            const details = this.buildDetailsObj(operationType, data, comServerToApplicationTimeoutSec);\n\n            const timeoutId = setTimeout(() => {\n                reject(\n                    new Error({\n                        status_code: CONSTANTS.REQUEST_TIMEOUT_RESPONSE_CODE,\n                    }),\n                );\n            }, browserToComServerTimeoutMS);\n\n            this.reqIdToPromiseMap.set(details.req_id, {\n                resolve,\n                rejectTimeout: timeoutId,\n            });\n            this.createAndDispatchAppExtensionEvent({ detail: details });\n        });\n    };\n\n    setupSafariExtensionCommunication = () => {\n        if (!this.isAppExtensionListenerAttached) {\n            this.isAppExtensionListenerAttached = true;\n            this.document.addEventListener(OUTPUT_EVENT, this.appExtensionEventResponseHandler);\n        }\n    };\n\n    tearDownSafariExtensionCommunication = () => {\n        if (this.isAppExtensionListenerAttached) {\n            this.isAppExtensionListenerAttached = false;\n            this.document.removeEventListener(OUTPUT_EVENT, this.appExtensionEventResponseHandler);\n        }\n    };\n\n    appExtensionEventResponseHandler = (responseVal: any) => {\n        const response = typeof responseVal.detail === 'string' ? JSON.parse(responseVal.detail) : responseVal.detail;\n\n        if (this.reqIdToPromiseMap.has(response.req_id)) {\n            const resolveObj = this.reqIdToPromiseMap.get(response.req_id);\n            if (resolveObj) {\n                clearTimeout(resolveObj.rejectTimeout);\n                this.reqIdToPromiseMap.delete(response.req_id);\n\n                const responseData =\n                    typeof response.com_server_response.data === 'string'\n                        ? JSON.parse(response.com_server_response.data)\n                        : response.com_server_response.data;\n\n                resolveObj.resolve(responseData);\n            }\n        }\n    };\n\n    createAndDispatchAppExtensionEvent = (payload: Object) => {\n        const { CustomEvent } = this.window;\n\n        const eventInstance = new CustomEvent(INPUT_EVENT, payload);\n        this.document.dispatchEvent(eventInstance);\n    };\n\n    getComServerStatus = (browserToComServerTimeoutMS: number, comServerToApplicationTimeoutSec: number) => {\n        return this.executeOperation(\n            CONSTANTS.OPERATION_STATUS,\n            null,\n            browserToComServerTimeoutMS,\n            comServerToApplicationTimeoutSec,\n        );\n    };\n\n    sendRequest = (data: Object, browserToComServerTimeoutMS: number, comServerToApplicationTimeoutSec: number) => {\n        return this.executeOperation(\n            CONSTANTS.OPERATION_REQUEST,\n            data,\n            browserToComServerTimeoutMS,\n            comServerToApplicationTimeoutSec,\n        );\n    };\n\n    sendCommand = (data: Object, browserToComServerTimeoutMS: number, comServerToApplicationTimeoutSec: number) => {\n        return this.executeOperation(\n            CONSTANTS.OPERATION_COMMAND,\n            data,\n            browserToComServerTimeoutMS,\n            comServerToApplicationTimeoutSec,\n        );\n    };\n\n    destroy = () => {\n        this.tearDownSafariExtensionCommunication();\n    };\n}\n\nexport default SafariChannel;\n"]},"metadata":{},"sourceType":"module"}