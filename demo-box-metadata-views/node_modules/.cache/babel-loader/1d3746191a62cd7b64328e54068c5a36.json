{"ast":null,"code":"function _typeof(obj) {\n  \"@babel/helpers - typeof\";\n\n  if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") {\n    _typeof = function _typeof(obj) {\n      return typeof obj;\n    };\n  } else {\n    _typeof = function _typeof(obj) {\n      return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj;\n    };\n  }\n  return _typeof(obj);\n}\nfunction _extends() {\n  _extends = Object.assign || function (target) {\n    for (var i = 1; i < arguments.length; i++) {\n      var source = arguments[i];\n      for (var key in source) {\n        if (Object.prototype.hasOwnProperty.call(source, key)) {\n          target[key] = source[key];\n        }\n      }\n    }\n    return target;\n  };\n  return _extends.apply(this, arguments);\n}\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    if (enumerableOnly) symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    });\n    keys.push.apply(keys, symbols);\n  }\n  return keys;\n}\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n    if (i % 2) {\n      ownKeys(Object(source), true).forEach(function (key) {\n        _defineProperty(target, key, source[key]);\n      });\n    } else if (Object.getOwnPropertyDescriptors) {\n      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));\n    } else {\n      ownKeys(Object(source)).forEach(function (key) {\n        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n      });\n    }\n  }\n  return target;\n}\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\nfunction _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  return Constructor;\n}\nfunction _possibleConstructorReturn(self, call) {\n  if (call && (_typeof(call) === \"object\" || typeof call === \"function\")) {\n    return call;\n  }\n  return _assertThisInitialized(self);\n}\nfunction _getPrototypeOf(o) {\n  _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) {\n    return o.__proto__ || Object.getPrototypeOf(o);\n  };\n  return _getPrototypeOf(o);\n}\nfunction _assertThisInitialized(self) {\n  if (self === void 0) {\n    throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");\n  }\n  return self;\n}\nfunction _inherits(subClass, superClass) {\n  if (typeof superClass !== \"function\" && superClass !== null) {\n    throw new TypeError(\"Super expression must either be null or a function\");\n  }\n  subClass.prototype = Object.create(superClass && superClass.prototype, {\n    constructor: {\n      value: subClass,\n      writable: true,\n      configurable: true\n    }\n  });\n  if (superClass) _setPrototypeOf(subClass, superClass);\n}\nfunction _setPrototypeOf(o, p) {\n  _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) {\n    o.__proto__ = p;\n    return o;\n  };\n  return _setPrototypeOf(o, p);\n}\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n  return obj;\n}\nimport * as React from 'react';\nimport getProp from 'lodash/get';\nimport { generatePath, matchPath } from 'react-router-dom';\nimport AnnotatorContext from './AnnotatorContext';\nimport { Action, Status } from './types';\nvar ANNOTATIONS_PATH = '/:sidebar/annotations/:fileVersionId/:annotationId?';\nvar defaultState = {\n  action: null,\n  activeAnnotationFileVersionId: null,\n  activeAnnotationId: null,\n  annotation: null,\n  error: null,\n  meta: null\n};\nexport default function withAnnotations(WrappedComponent) {\n  var ComponentWithAnnotations = /*#__PURE__*/\n  function (_React$Component) {\n    _inherits(ComponentWithAnnotations, _React$Component);\n    function ComponentWithAnnotations(props) {\n      var _this;\n      _classCallCheck(this, ComponentWithAnnotations);\n      _this = _possibleConstructorReturn(this, _getPrototypeOf(ComponentWithAnnotations).call(this, props)); // Determine by url if there is already a deeply linked annotation\n\n      _defineProperty(_assertThisInitialized(_this), \"annotator\", null);\n      _defineProperty(_assertThisInitialized(_this), \"emitActiveChangeEvent\", function (id) {\n        var _assertThisInitialize = _assertThisInitialized(_this),\n          annotator = _assertThisInitialize.annotator;\n        if (!annotator) {\n          return;\n        }\n        annotator.emit('annotations_active_set', id);\n      });\n      _defineProperty(_assertThisInitialized(_this), \"emitRemoveEvent\", function (id) {\n        var _assertThisInitialize2 = _assertThisInitialized(_this),\n          annotator = _assertThisInitialize2.annotator;\n        if (!annotator) {\n          return;\n        }\n        annotator.emit('annotations_remove', id);\n      });\n      _defineProperty(_assertThisInitialized(_this), \"handleAnnotationCreate\", function (eventData) {\n        var _eventData$annotation = eventData.annotation,\n          annotation = _eventData$annotation === void 0 ? null : _eventData$annotation,\n          _eventData$error = eventData.error,\n          error = _eventData$error === void 0 ? null : _eventData$error,\n          _eventData$meta = eventData.meta,\n          meta = _eventData$meta === void 0 ? null : _eventData$meta;\n        var onError = _this.props.onError;\n        if (onError && error) {\n          onError(error, 'create_annotation_error', {\n            showNotification: true\n          });\n        }\n        _this.setState(_objectSpread({}, _this.state, {\n          action: _this.getAction(eventData),\n          annotation: annotation,\n          error: error,\n          meta: meta\n        }));\n      });\n      _defineProperty(_assertThisInitialized(_this), \"handleActiveChange\", function (_ref) {\n        var annotationId = _ref.annotationId,\n          fileVersionId = _ref.fileVersionId;\n        _this.setState({\n          activeAnnotationFileVersionId: fileVersionId,\n          activeAnnotationId: annotationId\n        });\n      });\n      _defineProperty(_assertThisInitialized(_this), \"handleAnnotationFetchError\", function (_ref2) {\n        var error = _ref2.error;\n        var onError = _this.props.onError;\n        if (onError && error) {\n          onError(error, 'fetch_annotations_error', {\n            showNotification: true\n          });\n        }\n      });\n      _defineProperty(_assertThisInitialized(_this), \"handleAnnotator\", function (annotator) {\n        _this.annotator = annotator;\n        _this.annotator.addListener('annotations_active_change', _this.handleActiveChange);\n        _this.annotator.addListener('annotations_create', _this.handleAnnotationCreate);\n        _this.annotator.addListener('annotations_fetch_error', _this.handleAnnotationFetchError);\n      });\n      _defineProperty(_assertThisInitialized(_this), \"handlePreviewDestroy\", function () {\n        var shouldReset = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;\n        if (shouldReset) {\n          _this.setState(defaultState);\n        }\n        if (_this.annotator) {\n          _this.annotator.removeListener('annotations_active_change', _this.handleActiveChange);\n          _this.annotator.removeListener('annotations_create', _this.handleAnnotationCreate);\n          _this.annotator.removeListener('annotations_fetch_error', _this.handleAnnotationFetchError);\n        }\n        _this.annotator = null;\n      });\n      var location = props.location;\n      var match = _this.getMatchPath(location);\n      var activeAnnotationId = getProp(match, 'params.annotationId', null); // Seed the initial state with the activeAnnotationId if any from the location path\n\n      _this.state = _objectSpread({}, defaultState, {\n        activeAnnotationId: activeAnnotationId\n      });\n      return _this;\n    }\n    _createClass(ComponentWithAnnotations, [{\n      key: \"getAction\",\n      value: function getAction(_ref3) {\n        var status = _ref3.meta.status,\n          error = _ref3.error;\n        return status === Status.SUCCESS || error ? Action.CREATE_END : Action.CREATE_START;\n      }\n    }, {\n      key: \"getAnnotationsPath\",\n      value: function getAnnotationsPath(fileVersionId, annotationId) {\n        if (!fileVersionId) {\n          return '/activity';\n        }\n        return generatePath(ANNOTATIONS_PATH, {\n          sidebar: 'activity',\n          annotationId: annotationId || undefined,\n          fileVersionId: fileVersionId\n        });\n      }\n    }, {\n      key: \"getMatchPath\",\n      value: function getMatchPath(location) {\n        var pathname = getProp(location, 'pathname', '');\n        return matchPath(pathname, {\n          path: ANNOTATIONS_PATH,\n          exact: true\n        });\n      }\n    }, {\n      key: \"render\",\n      value: function render() {\n        return React.createElement(AnnotatorContext.Provider, {\n          value: {\n            emitActiveChangeEvent: this.emitActiveChangeEvent,\n            emitRemoveEvent: this.emitRemoveEvent,\n            getAnnotationsMatchPath: this.getMatchPath,\n            getAnnotationsPath: this.getAnnotationsPath,\n            state: this.state\n          }\n        }, React.createElement(WrappedComponent, _extends({}, this.props, {\n          onAnnotator: this.handleAnnotator,\n          onPreviewDestroy: this.handlePreviewDestroy\n        })));\n      }\n    }]);\n    return ComponentWithAnnotations;\n  }(React.Component);\n  var displayName = WrappedComponent.displayName || WrappedComponent.name || 'Component';\n  ComponentWithAnnotations.displayName = \"WithAnnotations(\".concat(displayName, \")\");\n  return ComponentWithAnnotations;\n}","map":{"version":3,"sources":["../../../../src/elements/common/annotator-context/withAnnotations.tsx"],"names":["React","getProp","generatePath","matchPath","AnnotatorContext","Action","Status","ANNOTATIONS_PATH","defaultState","action","activeAnnotationFileVersionId","activeAnnotationId","annotation","error","meta","withAnnotations","WrappedComponent","ComponentWithAnnotations","Component","props","location","match","getMatchPath","state","id","annotator","emit","status","SUCCESS","CREATE_END","CREATE_START","fileVersionId","annotationId","sidebar","undefined","pathname","path","exact","eventData","onError","showNotification","setState","getAction","addListener","handleActiveChange","handleAnnotationCreate","handleAnnotationFetchError","shouldReset","removeListener","emitActiveChangeEvent","emitRemoveEvent","getAnnotationsMatchPath","getAnnotationsPath","handleAnnotator","handlePreviewDestroy","displayName","name"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport getProp from 'lodash/get';\nimport { generatePath, match as matchType, matchPath } from 'react-router-dom';\nimport { Location } from 'history';\nimport AnnotatorContext from './AnnotatorContext';\nimport { Action, Annotator, AnnotationActionEvent, AnnotatorState, GetMatchPath, MatchParams, Status } from './types';\n\nexport type ActiveChangeEvent = {\n    annotationId: string | null;\n    fileVersionId: string;\n};\n\nexport type ActiveChangeEventHandler = (event: ActiveChangeEvent) => void;\n\nexport type ComponentWithAnnotations = {\n    emitActiveChangeEvent: (id: string | null) => void;\n    emitRemoveEvent: (id: string) => void;\n    getAction: (eventData: AnnotationActionEvent) => Action;\n    getAnnotationsPath: (fileVersionId?: string, annotationId?: string | null) => string;\n    getMatchPath: GetMatchPath;\n    handleActiveChange: ActiveChangeEventHandler;\n    handleAnnotationChangeEvent: (id: string | null) => void;\n    handleAnnotationCreate: (eventData: AnnotationActionEvent) => void;\n    handleAnnotationFetchError: ({ error }: { error: Error }) => void;\n    handleAnnotator: (annotator: Annotator) => void;\n    handlePreviewDestroy: (shouldReset?: boolean) => void;\n};\n\nexport type WithAnnotationsProps = {\n    location?: Location;\n    onAnnotator: (annotator: Annotator) => void;\n    onError?: (error: Error, code: string, contextInfo?: Record<string, unknown>) => void;\n    onPreviewDestroy: (shouldReset?: boolean) => void;\n};\n\nexport type WithAnnotationsComponent<P> = React.ComponentClass<P & WithAnnotationsProps>;\n\nconst ANNOTATIONS_PATH = '/:sidebar/annotations/:fileVersionId/:annotationId?';\nconst defaultState: AnnotatorState = {\n    action: null,\n    activeAnnotationFileVersionId: null,\n    activeAnnotationId: null,\n    annotation: null,\n    error: null,\n    meta: null,\n};\n\nexport default function withAnnotations<P extends object>(\n    WrappedComponent: React.ComponentType<P>,\n): WithAnnotationsComponent<P> {\n    class ComponentWithAnnotations extends React.Component<P & WithAnnotationsProps, AnnotatorState> {\n        static displayName: string;\n\n        annotator: Annotator | null = null;\n\n        constructor(props: P & WithAnnotationsProps) {\n            super(props);\n\n            // Determine by url if there is already a deeply linked annotation\n            const { location } = props;\n            const match = this.getMatchPath(location);\n            const activeAnnotationId = getProp(match, 'params.annotationId', null);\n\n            // Seed the initial state with the activeAnnotationId if any from the location path\n            this.state = { ...defaultState, activeAnnotationId };\n        }\n\n        emitActiveChangeEvent = (id: string | null) => {\n            const { annotator } = this;\n\n            if (!annotator) {\n                return;\n            }\n\n            annotator.emit('annotations_active_set', id);\n        };\n\n        emitRemoveEvent = (id: string) => {\n            const { annotator } = this;\n\n            if (!annotator) {\n                return;\n            }\n\n            annotator.emit('annotations_remove', id);\n        };\n\n        getAction({ meta: { status }, error }: AnnotationActionEvent): Action {\n            return status === Status.SUCCESS || error ? Action.CREATE_END : Action.CREATE_START;\n        }\n\n        getAnnotationsPath(fileVersionId?: string, annotationId?: string | null): string {\n            if (!fileVersionId) {\n                return '/activity';\n            }\n\n            return generatePath(ANNOTATIONS_PATH, {\n                sidebar: 'activity',\n                annotationId: annotationId || undefined,\n                fileVersionId,\n            });\n        }\n\n        getMatchPath(location?: Location): matchType<MatchParams> | null {\n            const pathname = getProp(location, 'pathname', '');\n            return matchPath<MatchParams>(pathname, {\n                path: ANNOTATIONS_PATH,\n                exact: true,\n            });\n        }\n\n        handleAnnotationCreate = (eventData: AnnotationActionEvent): void => {\n            const { annotation = null, error = null, meta = null } = eventData;\n            const { onError } = this.props;\n\n            if (onError && error) {\n                onError(error, 'create_annotation_error', { showNotification: true });\n            }\n\n            this.setState({\n                ...this.state,\n                action: this.getAction(eventData),\n                annotation,\n                error,\n                meta,\n            });\n        };\n\n        handleActiveChange: ActiveChangeEventHandler = ({ annotationId, fileVersionId }): void => {\n            this.setState({ activeAnnotationFileVersionId: fileVersionId, activeAnnotationId: annotationId });\n        };\n\n        handleAnnotationFetchError = ({ error }: { error: Error }): void => {\n            const { onError } = this.props;\n\n            if (onError && error) {\n                onError(error, 'fetch_annotations_error', { showNotification: true });\n            }\n        };\n\n        handleAnnotator = (annotator: Annotator): void => {\n            this.annotator = annotator;\n            this.annotator.addListener('annotations_active_change', this.handleActiveChange);\n            this.annotator.addListener('annotations_create', this.handleAnnotationCreate);\n            this.annotator.addListener('annotations_fetch_error', this.handleAnnotationFetchError);\n        };\n\n        handlePreviewDestroy = (shouldReset = true): void => {\n            if (shouldReset) {\n                this.setState(defaultState);\n            }\n\n            if (this.annotator) {\n                this.annotator.removeListener('annotations_active_change', this.handleActiveChange);\n                this.annotator.removeListener('annotations_create', this.handleAnnotationCreate);\n                this.annotator.removeListener('annotations_fetch_error', this.handleAnnotationFetchError);\n            }\n\n            this.annotator = null;\n        };\n\n        render(): JSX.Element {\n            return (\n                <AnnotatorContext.Provider\n                    value={{\n                        emitActiveChangeEvent: this.emitActiveChangeEvent,\n                        emitRemoveEvent: this.emitRemoveEvent,\n                        getAnnotationsMatchPath: this.getMatchPath,\n                        getAnnotationsPath: this.getAnnotationsPath,\n                        state: this.state,\n                    }}\n                >\n                    <WrappedComponent\n                        {...this.props}\n                        onAnnotator={this.handleAnnotator}\n                        onPreviewDestroy={this.handlePreviewDestroy}\n                    />\n                </AnnotatorContext.Provider>\n            );\n        }\n    }\n\n    const displayName = WrappedComponent.displayName || WrappedComponent.name || 'Component';\n    ComponentWithAnnotations.displayName = `WithAnnotations(${displayName})`;\n\n    return ComponentWithAnnotations;\n}\n"]},"metadata":{},"sourceType":"module"}